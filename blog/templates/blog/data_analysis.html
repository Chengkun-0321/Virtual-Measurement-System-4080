<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>è³‡æ–™åˆ†æé é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="d-flex flex-column min-vh-100" style="font-family: 'æ¨™æ¥·é«”';">
    {% include "blog/_navbar.html" %}
    <div class="container">
        <br>
        <!-- é é¢æ¨™é¡Œ -->
        <h2 class="mb-4 text-center">â¬‡ï¸ è³‡æ–™åˆ†æé é¢</h2>

        <!-- ä¼ºæœå™¨ é€£ç·šæç¤º -->
        <div id="ssh-status" class="text-center mb-3">
            <span class="text-warning fw-bold">ğŸŸ¡ ä¼ºæœå™¨é€£ç·šä¸­...</span>
        </div>

        <div class="mb-4 text-center">
            <label for="modelSelect" class="form-label fs-5">é¸æ“‡æ¨¡å‹åç¨±</label>
            <select id="modelSelect" class="form-select text-center mx-auto" style="max-width: 400px;">
                <option disabled selected>è¼‰å…¥ä¸­...</option>
            </select>
        </div>

        <!-- æ¨¡å‹æª”æ¡ˆä¸‹è¼‰ -->
        <div class="text-center">
            <button onclick="download('model')" class="btn btn-primary m-2">ğŸ“¥ ä¸‹è¼‰æ¨¡å‹æª”æ¡ˆ</button>
        </div>

        <!-- é¡¯ç¤ºåœ–ç‰‡å€å¡Š -->
        <div id="imageContainer" class="mt-5">
            <h4 class="text-center mb-4">ğŸ“Š åˆ†æåœ–è¡¨é è¦½</h4>
            <!-- ç¬¬ä¸€æ’ï¼šMAPE & MSE ä¸¦æ’ -->
            <div class="row mb-4">
                <div class="col-md-6 text-center">
                    <h6>MAPE æ›²ç·š</h6>
                    <img id="img-mape" class="img-fluid rounded shadow"
                        style="height:380px; width:100%; object-fit:contain;"
                        onerror="handleImageError(this)">
                    <div id="err-img-mape" class="text-danger mt-2 fw-bold" style="display: none;">æ‰¾ä¸åˆ°åœ–æª”</div>
                </div>
                <div class="col-md-6 text-center">
                    <h6>MSE æ›²ç·š</h6>
                    <img id="img-mse" class="img-fluid rounded shadow"
                        style="height:380px; width:100%; object-fit:contain;"
                        onerror="handleImageError(this)">
                    <div id="err-img-mse" class="text-danger mt-2 fw-bold" style="display: none;">æ‰¾ä¸åˆ°åœ–æª”</div>
                </div>
            </div>

            <!-- ç¬¬äºŒæ’ï¼šLoss & MAE ä¸¦æ’ -->
            <div class="row mb-4">
                <div class="col-md-6 text-center">
                    <h6>Loss æ›²ç·š</h6>
                    <img id="img-loss" class="img-fluid rounded shadow"
                        style="height:380px; width:100%; object-fit:contain;"
                        onerror="handleImageError(this)">
                    <div id="err-img-loss" class="text-danger mt-2 fw-bold" style="display: none;">æ‰¾ä¸åˆ°åœ–æª”</div>
                </div>
                <div class="col-md-6 text-center">
                    <h6>MAE æ›²ç·š</h6>
                    <img id="img-mae" class="img-fluid rounded shadow"
                        style="height:380px; width:100%; object-fit:contain;"
                        onerror="handleImageError(this)">
                    <div id="err-img-mae" class="text-danger mt-2 fw-bold" style="display: none;">æ‰¾ä¸åˆ°åœ–æª”</div>
                </div>
            </div>

            <!-- ç¬¬ä¸‰æ’ï¼šGround Truth vs é æ¸¬ï¼ˆå…¨å¯¬ï¼‰ -->
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <h5>Ground Truth vs é æ¸¬</h5>
                    <img id="img-gt" class="img-fluid rounded shadow"
                        style="height:400px; width:100%; object-fit:contain;"
                        onerror="handleImageError(this)">
                    <div id="err-img-gt" class="text-danger mt-2 fw-bold" style="display: none;">æ‰¾ä¸åˆ°åœ–æª”</div>
                </div>
            </div>

            <!-- ç¬¬å››æ’ï¼šæ··æ·†çŸ©é™£ï¼ˆç¨ç«‹æ­£æ–¹å½¢ + ç½®ä¸­ï¼‰ -->
            <div class="row mb-4">
                <div class="col-12 text-center">
                    <h5>æ··æ·†çŸ©é™£</h5>
                    <div style="max-width:450px; margin:auto;">
                        <img id="img-confusion" class="img-fluid rounded shadow"
                            style="width:100%; aspect-ratio: 1 / 1; object-fit:contain;"
                            onerror="handleImageError(this)">
                        <div id="err-img-confusion" class="text-danger mt-2 fw-bold" style="display: none;">æ‰¾ä¸åˆ°åœ–æª”</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¿”å›é¦–é æŒ‰éˆ• -->
        <div class="text-center mt-4">
            <a href="/" class="btn btn-secondary btn-lg">ğŸ”™ è¿”å›é¦–é </a>
        </div>
    </div>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const sshStatus = document.getElementById('ssh-status');
        const socket = new WebSocket("ws://" + window.location.host + "/ws/CMD/");

        socket.onopen = function () {
            console.log("âœ… WebSocket å·²é€£ç·š");
            sshStatus.innerHTML = `<span class="text-success fw-bold">ğŸŸ¢ ä¼ºæœå™¨ å·²é€£ç·š</span>`;
        };

        // è¼‰å…¥æ¨¡å‹é¸å–®
        fetch("/api/list_model_names/")
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("modelSelect");
                select.innerHTML = ""; // æ¸…ç©ºåŸæœ¬çš„ option
                if (data.models && data.models.length > 0) {
                    data.models.forEach(name => {
                        const option = document.createElement("option");
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });
                    // è‡ªå‹•è¼‰å…¥ç¬¬ä¸€å€‹æ¨¡å‹åœ–ç‰‡
                    select.value = data.models[0];
                    loadImages(data.models[0]);
                } else {
                    const option = document.createElement("option");
                    option.textContent = "âš ï¸ æ‰¾ä¸åˆ°æ¨¡å‹æª”æ¡ˆ";
                    option.disabled = true;
                    select.appendChild(option);
                }
            })
            .catch(err => {
                console.error("è®€å–æ¨¡å‹æ¸…å–®å¤±æ•—", err);
                const select = document.getElementById("modelSelect");
                select.innerHTML = `<option disabled>ğŸš« è¼‰å…¥å¤±æ•—</option>`;
            });
    });

    function download(type) {
        const modelSelect = document.getElementById("modelSelect");
        const modelName = modelSelect.value;
        if (!modelName) {
            alert("è«‹é¸æ“‡æ¨¡å‹åç¨±ï¼");
            return;
        }
        const url = `/analysis/file/${type}/${modelName}/`;
        window.location.href = url;
    }
    function downloadAll() {
        const modelSelect = document.getElementById("modelSelect");
        const modelName = modelSelect.value;
        if (!modelName) {
            alert("è«‹é¸æ“‡æ¨¡å‹åç¨±ï¼");
            return;
        }
        const url = `/analysis/all/${modelName}/`;
        window.location.href = url;
    }

    function loadImages(modelName) {
        const folder = modelName;

        const imageMap = {
            "img-confusion": "æ··æ·†çŸ©é™£.png",
            "img-gt": "ground_truth.png",
            "img-loss": "training_loss_curve.png",
            "img-mae": "training_mae_curve.png",
            "img-mape": "training_mape_curve.png",
            "img-mse": "training_mse_curve.png"
        };

        for (const [id, filename] of Object.entries(imageMap)) {
            const img = document.getElementById(id);
            img.src = `/api/get_image/${folder}/${filename}`;
        }
    }

    function handleImageError(imgElement) {
        imgElement.style.display = "none";  // éš±è—åœ–ç‰‡
        const errorDiv = document.getElementById("err-" + imgElement.id);
        if (errorDiv) {
            errorDiv.style.display = "block";  // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        }
    }

    function loadImages(modelName) {
        const folder = modelName;

        const imageMap = {
            "img-confusion": "æ··æ·†çŸ©é™£.png",
            "img-gt": "ground_truth.png",
            "img-loss": "training_loss_curve.png",
            "img-mae": "training_mae_curve.png",
            "img-mape": "training_mape_curve.png",
            "img-mse": "training_mse_curve.png"
        };

        for (const [id, filename] of Object.entries(imageMap)) {
            const img = document.getElementById(id);
            const err = document.getElementById("err-" + id);
            img.style.display = "block";  // æ¯æ¬¡è¼‰å…¥å‰é‡è¨­ç‚ºå¯è¦‹
            if (err) err.style.display = "none";  // æ¯æ¬¡è¼‰å…¥å‰æ¸…é™¤éŒ¯èª¤è¨Šæ¯
            img.src = `/api/get_image/${folder}/${filename}`;
        }
    }

    document.getElementById("modelSelect").addEventListener("change", function () {
        const modelName = this.value;
        if (modelName) {
            loadImages(modelName);
        }
    });
</script>
</body>
</html>