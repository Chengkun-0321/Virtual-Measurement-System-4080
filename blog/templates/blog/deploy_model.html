<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>éƒ¨ç½²æ¨¡å‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="d-flex flex-column min-vh-100" style="font-family: 'æ¨™æ¥·é«”';">
    {% include "blog/_navbar.html" %}
    <div class="container">
        <br>
        <!-- é é¢æ¨™é¡Œ -->
        <h2 class="mb-4 text-center">ğŸ”° éƒ¨ç½²æ¨¡å‹</h2>

        <!-- ä¼ºæœå™¨ é€£ç·šæç¤º -->
        <div id="ssh-status" class="text-center mb-3">
            <span class="text-warning fw-bold">ğŸŸ¡ ä¼ºæœå™¨é€£ç·šä¸­...</span>
        </div>

        <!-- åŒ¯å…¥ CSV -->
        <form id="upload-form" enctype="multipart/form-data" class="mb-4">
            <label for="csv-file" class="form-label fw-bold">åŒ¯å…¥è£½ç¨‹åƒæ•¸ï¼ˆCSVï¼‰:</label>
            <input type="file" id="csv-file" name="file" accept=".csv" class="form-control mb-2">
            <button type="submit" class="btn btn-primary">ä¸Šå‚³ä¸¦é è¦½è³‡æ–™</button>
        </form>

        <!-- è³‡æ–™è¡¨æ ¼ -->
        <div id="data-table-container" class="scroll-table mb-4 d-none">
            <table id="data-table" class="table table-bordered table-sm">
                <thead class="table-light"></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- æ¨¡å‹é¸æ“‡ -->
        <div class="mb-3">
            <label for="model-select" class="form-label fw-bold">é¸æ“‡æ¨¡å‹ï¼š</label>
            <select id="model-select" class="form-select"></select>
        </div>

        <!-- é æ¸¬æŒ‰éˆ• -->
        <button id="predict-btn" class="btn btn-success mb-3">åŸ·è¡Œé æ¸¬</button>

        <!-- é æ¸¬çµæœ -->
        <div id="prediction-result" class="alert alert-info d-none"></div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const sshStatus = document.getElementById('ssh-status');
            const socket = new WebSocket("ws://" + window.location.host + "/ws/CMD/");

            socket.onopen = function () {
                console.log("âœ… WebSocket å·²é€£ç·š");
                sshStatus.innerHTML = `<span class="text-success fw-bold">ğŸŸ¢ ä¼ºæœå™¨ å·²é€£ç·š</span>`;
            };
        });

        // ä¸Šå‚³ CSV
        document.getElementById('upload-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch('/api/upload_csv/', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.columns && data.rows) {
                    const table = document.getElementById('data-table');
                    const thead = table.querySelector('thead');
                    const tbody = table.querySelector('tbody');
                    thead.innerHTML = '';
                    tbody.innerHTML = '';

                    // æ¨™é¡Œåˆ—
                    const headRow = document.createElement('tr');
                    headRow.innerHTML = `<th>é¸å–</th>` + data.columns.map(col => `<th>${col}</th>`).join('');
                    thead.appendChild(headRow);

                    // è³‡æ–™åˆ—
                    data.rows.forEach((row, i) => {
                        const rowHtml = `<td><input type="checkbox" class="row-select" value="${i}"></td>` +
                            row.map(val => `<td>${val}</td>`).join('');
                        const tr = document.createElement('tr');
                        tr.innerHTML = rowHtml;
                        tbody.appendChild(tr);
                    });

                    document.getElementById('data-table-container').classList.remove('d-none');
                }
            });
        });

        // å–å¾—æ¨¡å‹é¸å–®
        fetch('/api/list_model_names/')
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('model-select');
                data.models.forEach(model => {
                    const opt = document.createElement('option');
                    opt.value = model;
                    opt.textContent = model;
                    select.appendChild(opt);
                });
            });

        // é æ¸¬
        document.getElementById('predict-btn').addEventListener('click', function () {
            const checkboxes = document.querySelectorAll('.row-select:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const modelName = document.getElementById('model-select').value;

            fetch('/api/predict/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ indices: selectedIndices, model: modelName })
            })
            .then(res => res.json())
            .then(data => {
                const resultDiv = document.getElementById('prediction-result');
                resultDiv.classList.remove('d-none');
                resultDiv.innerHTML = `<strong>é æ¸¬çµæœï¼š</strong><br>${data.predictions.join('<br>')}`;
            });
        });
    </script>
</body>
</html>