<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>éƒ¨ç½²æ¨¡å‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #data-table thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 1;
        }

        /* ç¬¬ä¸€æ¬„ï¼ˆå‹¾é¸æ¡†ï¼‰å¯¬åº¦çª„ä¸€é» */
        #data-table th:first-child,
        #data-table td:first-child {
            min-width: 50px;
            max-width: 50px;
            width: 50px;
            text-align: center;
        }

        /* å…¶ä»–æ¬„çµ±ä¸€å¯¬åº¦ */
        #data-table th:not(:first-child),
        #data-table td:not(:first-child) {
            min-width: 120px;
            max-width: 120px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scroll-wrapper {
            display: flex;
            height: 400px;
        }

        #data-table-container,
        #prediction-table-container {
            overflow-y: scroll;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100" style="font-family: 'æ¨™æ¥·é«”';">
    {% include "blog/_navbar.html" %}
    <div class="container">
        <br>
        <!-- é é¢æ¨™é¡Œ -->
        <h2 class="mb-4 text-center">ğŸ”° éƒ¨ç½²æ¨¡å‹</h2>

        <!-- ä¼ºæœå™¨ é€£ç·šæç¤º -->
        <div id="ssh-status" class="text-center mb-3">
            <span class="text-warning fw-bold">ğŸŸ¡ ä¼ºæœå™¨é€£ç·šä¸­...</span>
        </div>

        <!-- åˆä½µè¡¨å–®èˆ‡æ¨¡å‹é¸æ“‡ç‚ºä¸€æ’ -->
        <div class="d-flex justify-content-center align-items-end gap-4 flex-wrap mb-4">

            <!-- ä¸Šå‚³å€ -->
            <form id="upload-form" enctype="multipart/form-data" class="d-flex align-items-end gap-2 flex-wrap">
                <div>
                    <label for="csv-file" class="form-label fw-bold">åŒ¯å…¥è£½ç¨‹åƒæ•¸ï¼ˆCSVï¼‰:</label>
                    <!--<input type="file" id="csv-file" name="file" accept=".csv" class="form-control">-->
                    <input type="file" id="npy-file" name="file" accept=".npy" class="form-control">
                </div>
                <div>
                    <button type="submit" class="btn btn-primary">ä¸Šå‚³ä¸¦é è¦½è³‡æ–™</button>
                </div>
                <div>
                    <a href="{% url 'download_sample' %}" class="btn btn-outline-secondary">ä¸‹è¼‰æä¾›çš„è£½ç¨‹åƒæ•¸è³‡æ–™</a>
                </div>
            </form>

            <!-- æ¨¡å‹é¸æ“‡å€ -->
            <div class="d-flex align-items-end gap-2 flex-wrap">
                <div>
                    <label for="model-select" class="form-label fw-bold">é¸æ“‡æ¨¡å‹ï¼š</label>
                    <select id="model-select" class="form-select w-auto"></select>
                </div>
                <div>
                    <button id="predict-btn" class="btn btn-success">åŸ·è¡Œé æ¸¬</button>
                </div>
            </div>

        </div>

        <div class="row mb-2">
            <div class="col-md-10 text-center">
                <h5>ä¸Šå‚³è³‡æ–™æª¢è¦–å€</h5>
            </div>
            <div class="col-md-2 text-center">
                <h5>é æ¸¬é¡¯ç¤ºå€</h5>
            </div>
        </div>

        <div class="scroll-wrapper d-flex">
            <!-- å·¦é‚Š -->
            <div id="data-table-container" class="table-responsive mb-4" style="max-height: 400px; overflow-y: auto; width: 83%;">
                <table id="data-table" class="table table-bordered table-sm">
                    <thead class="table-light"></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- å³é‚Š -->
            <div id="prediction-table-container" class="table-responsive mb-4" style="max-height: 400px; overflow-y: auto; width: 15%; margin-left: auto;">
                <table id="prediction-table" class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr><th>#</th><th>é æ¸¬å€¼</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- é æ¸¬çµæœ -->
        <div id="prediction-result" class="alert alert-info d-none"></div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const sshStatus = document.getElementById('ssh-status');
            const socket = new WebSocket("ws://" + window.location.host + "/ws/CMD/");

            socket.onopen = function () {
                console.log("âœ… WebSocket å·²é€£ç·š");
                sshStatus.innerHTML = `<span class="text-success fw-bold">ğŸŸ¢ ä¼ºæœå™¨ å·²é€£ç·š</span>`;
            };
        });

        // ä¸Šå‚³ npy
        document.getElementById('upload-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            fetch('/api/upload_npy/', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.columns && data.rows) {
                    const table = document.getElementById('data-table');
                    const thead = table.querySelector('thead');
                    const tbody = table.querySelector('tbody');
                    thead.innerHTML = '';
                    tbody.innerHTML = '';

                    // æ¨™é¡Œåˆ—
                    const headRow = document.createElement('tr');
                    headRow.innerHTML = `<th><input type="checkbox" id="select-all"></th>` + data.columns.map(col => `<th>${col}</th>`).join('');
                    thead.appendChild(headRow);

                    // è³‡æ–™åˆ—
                    data.rows.forEach((row, i) => {
                        const rowHtml = `<td><input type="checkbox" class="row-select" value="${i}"></td>` +
                            row.map(val => `<td>${val}</td>`).join('');
                        const tr = document.createElement('tr');
                        tr.innerHTML = rowHtml;
                        tbody.appendChild(tr);
                    });

                    document.getElementById('data-table-container').classList.remove('d-none');
                }
            });
        });

        // å–å¾—æ¨¡å‹é¸å–®
        fetch('/api/list_model_names/')
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('model-select');
                data.models.forEach(model => {
                    const opt = document.createElement('option');
                    opt.value = model;
                    opt.textContent = model;
                    select.appendChild(opt);
                });
            });
        
        // å…¨é¸/å–æ¶ˆå…¨é¸é‚è¼¯
        document.addEventListener('change', function (e) {
            if (e.target && e.target.id === 'select-all') {
                const allCheckboxes = document.querySelectorAll('.row-select');
                allCheckboxes.forEach(cb => cb.checked = e.target.checked);
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            const left = document.getElementById('data-table-container');
            const right = document.getElementById('prediction-table-container');

            // å·¦å³åŒæ­¥æ»¾å‹•
            left.addEventListener('scroll', () => {
                right.scrollTop = left.scrollTop;
            });
            right.addEventListener('scroll', () => {
                left.scrollTop = right.scrollTop;
            });
        });

        // é æ¸¬
        document.getElementById('predict-btn').addEventListener('click', function () {
            const checkboxes = document.querySelectorAll('.row-select:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const modelName = document.getElementById('model-select').value;

            fetch('/api/predict/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ indices: selectedIndices, model: modelName })
            })
            .then(res => res.json())
            .then(data => {
                if (data.predictions) {
                    // é¡¯ç¤ºé æ¸¬çµæœå€åŸŸ
                    const predictionContainer = document.getElementById('prediction-table-container');
                    const predictionTableBody = document.querySelector('#prediction-table tbody');
                    predictionTableBody.innerHTML = '';  // æ¸…ç©ºåŸæœ‰è³‡æ–™
                    predictionContainer.classList.remove('d-none');

                    // å°‡æ¯ç­†é æ¸¬çµæœé¡¯ç¤ºåˆ°è¡¨æ ¼
                    data.predictions.forEach((value, i) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${selectedIndices[i] + 1}</td><td>${value}</td>`;
                        predictionTableBody.appendChild(tr);
                    });

                    // é¡¯ç¤ºç°¡æ˜“é æ¸¬çµæœè¨Šæ¯
                    const resultDiv = document.getElementById('prediction-result');
                    resultDiv.classList.remove('d-none');
                    resultDiv.innerHTML = `<strong>é æ¸¬å®Œæˆï¼Œå…± ${data.predictions.length} ç­†è³‡æ–™ã€‚</strong>`;
                } else {
                    alert("é æ¸¬å¤±æ•—ï¼š" + (data.error || "æœªçŸ¥éŒ¯èª¤"));
                }
            })
            .catch(err => {
                alert("é æ¸¬è«‹æ±‚å¤±æ•—ï¼š" + err);
            });
        });
    </script>
</body>
</html>