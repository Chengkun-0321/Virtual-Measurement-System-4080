<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>模型管理頁面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="d-flex flex-column min-vh-100" style="font-family: '標楷體';">
    {% include "blog/_navbar.html" %}
    <div class="container">
        <br>
        <!-- 頁面標題 -->
        <h2 class="mb-4 text-center">📂 模型管理頁面</h2>

        <!-- 伺服器 連線提示 -->
        <div id="ssh-status" class="text-center mb-3">
            <span class="text-warning fw-bold">🟡 伺服器 連線中...</span>
        </div>

        <!-- 篩選條件 -->
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="filter-name" class="form-control" placeholder="🔍 搜尋模型名稱">
            </div>
            <div class="col-md-4">
                <input type="date" id="filter-date" class="form-control" placeholder="📅 建立時間">
            </div>
            <div class="col-md-4 d-flex">
                <input type="number" id="mse-min" class="form-control me-2" placeholder="MSE 最小值">
                <input type="number" id="mse-max" class="form-control" placeholder="MSE 最大值">
            </div>
        </div>

        <!-- 權重管理區塊 -->
        <div class="card mt-4 shadow-sm">
            <div class="card-header">
                🗂️ 模型權重管理
            </div>
            <div class="card-body">
                <table class="table table-bordered" id="weights-table">
                    <thead>
                        <tr>
                            <th><button class="btn btn-outline-secondary btn-sm" id="toggle-select-all">全選</button></th>
                            <th>檔名</th>
                            <th>檔案大小</th>
                            <th>建立時間</th>
                            <th>MSE</th>
                            <th>檔名修改</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center text-muted">📂 載入中...</td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-danger" id="delete-selected">🗑️ 刪除選擇</button>
            </div>
        </div>

        
        <!-- 返回首頁按鈕 -->
        <div class="text-center mt-4">
            <a href="/" class="btn btn-secondary btn-lg">🔙 返回首頁</a>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const sshStatus = document.getElementById('ssh-status');

            const socket = new WebSocket("ws://" + window.location.host + "/ws/CMD/");
            
            // 當 WebSocket 連線成功
            socket.onopen = function() {
                console.log("WebSocket 已連線");
                sshStatus.innerHTML = `<span class="text-success fw-bold">🟢 伺服器 已連線</span>`;
            };

            const tableBody = document.querySelector("#weights-table tbody");
            const selectAllCheckbox = document.getElementById("select-all");
            const deleteButton = document.getElementById("delete-selected");

            ["filter-name", "filter-date", "mse-min", "mse-max"].forEach(id => {
                document.getElementById(id).addEventListener("input", loadWeights);
            });

            function loadWeights() {
                fetch('/api/list_checkpoint/')
                    .then(res => res.json())
                    .then(data => {
                        console.log("載入權重資料:", data); // DEBUG: 看 API 回傳

                        const nameFilter = document.getElementById("filter-name").value.toLowerCase();
                        const dateFilter = document.getElementById("filter-date").value;
                        const mseMin = parseFloat(document.getElementById("mse-min").value);
                        const mseMax = parseFloat(document.getElementById("mse-max").value);

                        // 過濾邏輯
                        const filtered = data.filter(file => {
                            let matchName = !nameFilter || file.name.toLowerCase().includes(nameFilter);
                            let matchDate = !dateFilter || file.date_iso === dateFilter;
                            let matchMSE = true;
                            if (!isNaN(mseMin)) matchMSE = file.mse !== null && file.mse >= mseMin;
                            if (!isNaN(mseMax)) matchMSE = matchMSE && file.mse !== null && file.mse <= mseMax;
                            return matchName && matchDate && matchMSE;
                        });

                        tableBody.innerHTML = "";
                        if (data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">📂 沒有權重檔案</td></tr>';
                            return;
                        }

                        filtered.forEach(file => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td><input type="checkbox" class="file-checkbox" value="${file.name}"></td>
                                <td>${file.name}.h5</td>
                                <td>${file.size}</td>
                                <td>${file.date}</td>
                                <td>${file.mse !== null ? file.mse : "-"}</td>
                                <td><button class="btn btn-sm btn-outline-primary rename-btn" data-old="${file.name}">✏️ 修改名稱</button></td>
                            `;
                            tableBody.appendChild(row);
                        });
                    });
            }

            // 全選功能按鈕
            const toggleSelectAllButton = document.getElementById("toggle-select-all");
            let isAllSelected = false;

            toggleSelectAllButton.addEventListener("click", function () {
                const checkboxes = document.querySelectorAll(".file-checkbox");
                isAllSelected = !isAllSelected;

                checkboxes.forEach(cb => {
                    cb.checked = isAllSelected;
                });

                // 切換按鈕文字
                if (isAllSelected) {
                    toggleSelectAllButton.textContent = "全不選";
                } else {
                    toggleSelectAllButton.textContent = "全選";
                }
            });

            // 刪除選擇檔案
            deleteButton.addEventListener("click", function () {
                const selectedFiles = Array.from(document.querySelectorAll(".file-checkbox:checked"))
                    .map(cb => cb.value);
                if (selectedFiles.length === 0) {
                    alert("請先選擇要刪除的檔案！");
                    return;
                }
                if (confirm(`⚠️ 確定要刪除這 ${selectedFiles.length} 個檔案嗎？`)) {
                    fetch('/api/delete_local_weights/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filenames: selectedFiles })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "success") {
                            alert("✅ 刪除成功");
                            loadWeights();
                        } else {
                            alert(`❌ 刪除失敗：${data.error}`);
                        }
                    });
                }
            });

            // 修改名稱
            tableBody.addEventListener("click", function (e) {
                if (e.target.classList.contains("rename-btn")) {
                    const oldName = e.target.getAttribute("data-old");
                    const newName = prompt("請輸入新的模型名稱（不含副檔名）", oldName);
                    if (newName && newName !== oldName) {
                        fetch('/api/rename_checkpoint/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ old_name: oldName, new_name: newName })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === "success") {
                                alert("✅ 修改成功！");
                                loadWeights();
                            } else {
                                alert("❌ 修改失敗：" + data.error);
                            }
                        });
                    }
                }
            });

            loadWeights();
        });
    </script>
</body>
</html>