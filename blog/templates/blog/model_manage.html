<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>æ¨¡å‹ç®¡ç†é é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="d-flex flex-column min-vh-100" style="font-family: 'æ¨™æ¥·é«”';">
    {% include "blog/_navbar.html" %}
    <div class="container">
        <br>
        <!-- é é¢æ¨™é¡Œ -->
        <h2 class="mb-4 text-center">ğŸ“‚ æ¨¡å‹ç®¡ç†é é¢</h2>

        <!-- ä¼ºæœå™¨ é€£ç·šæç¤º -->
        <div id="ssh-status" class="text-center mb-3">
            <span class="text-warning fw-bold">ğŸŸ¡ ä¼ºæœå™¨ é€£ç·šä¸­...</span>
        </div>

        <!-- ç¯©é¸æ¢ä»¶ -->
        <div class="row mb-3">
            <div class="col-md-3">
                <input type="text" id="filter-name" class="form-control" placeholder="ğŸ” æœå°‹æ¨¡å‹åç¨±">
            </div>
            <div class="col-md-3 d-flex">
                <select id="sort-date" class="form-select me-2">
                    <option value="none">ğŸ•’ æ™‚é–“æ’åº</option>
                    <option value="date_desc">ğŸ•’ æœ€æ–°</option>
                    <option value="date_asc">ğŸ•’ æœ€èˆŠ</option>
                </select>
                <select id="sort-acc" class="form-select">
                    <option value="none">ğŸ“‰ ACCæ’åº</option>
                    <option value="acc_asc">ğŸ“‰ ACC â–³</option>
                    <option value="acc_desc">ğŸ“ˆ ACC â–½</option>
                </select>
            </div>
        </div>

        <!-- æ¬Šé‡ç®¡ç†å€å¡Š -->
        <div class="card mt-4 shadow-sm">
            <div class="card-header">
                ğŸ—‚ï¸ æ¨¡å‹æ¬Šé‡ç®¡ç†
            </div>
            <div class="card-body">
                <table class="table table-bordered" id="weights-table">
                    <thead>
                        <tr>
                            <th>æª”å</th>
                            <th>å»ºç«‹æ™‚é–“</th>
                            <th>ACC</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center text-muted">ğŸ“‚ è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const sshStatus = document.getElementById('ssh-status');

        const socket = new WebSocket("ws://" + window.location.host + "/ws/CMD/");

        socket.onopen = function() {
            console.log("WebSocket å·²é€£ç·š");
            sshStatus.innerHTML = `<span class="text-success fw-bold">ğŸŸ¢ ä¼ºæœå™¨ å·²é€£ç·š</span>`;
        };

        const tableBody = document.querySelector("#weights-table tbody");

        // æœå°‹æ¬„ã€æ’åºæ¬„ä½éƒ½åŠ å…¥äº‹ä»¶
        document.getElementById("filter-name").addEventListener("input", loadWeights);
        document.getElementById("sort-date").addEventListener("change", loadWeights);
        document.getElementById("sort-acc").addEventListener("change", loadWeights);

        // æ¸…é™¤å¦ä¸€å€‹æ’åºé¸å–®
        document.getElementById("sort-acc").addEventListener("change", () => {
            document.getElementById("sort-date").value = "none";
            loadWeights();
        });

        document.getElementById("sort-date").addEventListener("change", () => {
            document.getElementById("sort-acc").value = "none";
            loadWeights();
        });

        function loadWeights() {
            let url = '/api/list_checkpoint/';
            const params = [];

            const dateSort = document.getElementById("sort-date").value;
            const accSort = document.getElementById("sort-acc").value;

            if (dateSort && dateSort !== "none") {
                const [sort_by, order] = dateSort.split("_");
                params.push(`sort_by=${sort_by}`);
                params.push(`order=${order}`);
            }

            if (accSort && accSort !== "none") {
                const [sort_by, order] = accSort.split("_");
                params.push(`sort_by=${sort_by}`);
                params.push(`order=${order}`);
            }

            if (params.length > 0) {
                url += "?" + params.join("&");
            }

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const nameFilter = document.getElementById("filter-name").value.toLowerCase();

                    const filtered = data.filter(file => {
                        return !nameFilter || file.name.toLowerCase().includes(nameFilter);
                    });

                    tableBody.innerHTML = "";
                    if (filtered.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ğŸ“‚ æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ¨¡å‹æª”æ¡ˆ</td></tr>';
                        return;
                    }

                    filtered.forEach(file => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${file.name}.h5</td>
                            <td>${file.date}</td>
                            <td>${file.acc !== null ? parseFloat(file.acc).toFixed(2) : "-"} %</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary rename-btn" data-old="${file.name}">âœï¸ ä¿®æ”¹åç¨±</button>
                                <button class="btn btn-sm btn-outline-danger ms-2 delete-btn" data-name="${file.name}">ğŸ—‘ï¸ åˆªé™¤</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                });
        }

        tableBody.addEventListener("click", function (e) {
            if (e.target.classList.contains("rename-btn")) {
                const oldName = e.target.getAttribute("data-old");
                const newName = prompt("è«‹è¼¸å…¥æ–°çš„æ¨¡å‹åç¨±ï¼ˆä¸å«å‰¯æª”åï¼‰", oldName);
                if (newName && newName !== oldName) {
                    fetch('/api/rename_checkpoint/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ old_name: oldName, new_name: newName })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "success") {
                            alert("âœ… ä¿®æ”¹æˆåŠŸï¼");
                            loadWeights();
                        } else {
                            alert("âŒ ä¿®æ”¹å¤±æ•—ï¼š" + data.error);
                        }
                    });
                }
            }

            if (e.target.classList.contains("delete-btn")) {
                const filename = e.target.getAttribute("data-name");
                if (confirm(`ç¢ºå®šè¦åˆªé™¤æ¨¡å‹ã€Œ${filename}.h5ã€å—ï¼Ÿ`)) {
                    fetch('/api/delete_local_weights/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filenames: [filename] })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "success") {
                            alert("âœ… åˆªé™¤æˆåŠŸ");
                            loadWeights();
                        } else {
                            alert(`âŒ åˆªé™¤å¤±æ•—ï¼š${data.error}`);
                        }
                    });
                }
            }
        });

        loadWeights();
    });
</script>
</body>
</html>