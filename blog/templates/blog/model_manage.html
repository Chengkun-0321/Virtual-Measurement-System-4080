<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>æ¨¡å‹ç®¡ç†é é¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="d-flex flex-column min-vh-100" style="font-family: 'æ¨™æ¥·é«”';">
    {% include "blog/_navbar.html" %}
    <div class="container">
        <br>
        <!-- é é¢æ¨™é¡Œ -->
        <h2 class="mb-4 text-center">ğŸ“‚ æ¨¡å‹ç®¡ç†é é¢</h2>

        <!-- ä¼ºæœå™¨ é€£ç·šæç¤º -->
        <div id="ssh-status" class="text-center mb-3">
            <span class="text-warning fw-bold">ğŸŸ¡ ä¼ºæœå™¨ é€£ç·šä¸­...</span>
        </div>

        <!-- ç¯©é¸æ¢ä»¶ -->
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="filter-name" class="form-control" placeholder="ğŸ” æœå°‹æ¨¡å‹åç¨±">
            </div>
            <div class="col-md-4">
                <input type="date" id="filter-date" class="form-control" placeholder="ğŸ“… å»ºç«‹æ™‚é–“">
            </div>
            <div class="col-md-4 d-flex">
                <input type="number" id="mse-min" class="form-control me-2" placeholder="MSE æœ€å°å€¼">
                <input type="number" id="mse-max" class="form-control" placeholder="MSE æœ€å¤§å€¼">
            </div>
        </div>

        <!-- æ¬Šé‡ç®¡ç†å€å¡Š -->
        <div class="card mt-4 shadow-sm">
            <div class="card-header">
                ğŸ—‚ï¸ æ¨¡å‹æ¬Šé‡ç®¡ç†
            </div>
            <div class="card-body">
                <table class="table table-bordered" id="weights-table">
                    <thead>
                        <tr>
                            <th><button class="btn btn-outline-secondary btn-sm" id="toggle-select-all">å…¨é¸</button></th>
                            <th>æª”å</th>
                            <th>æª”æ¡ˆå¤§å°</th>
                            <th>å»ºç«‹æ™‚é–“</th>
                            <th>MSE</th>
                            <th>æª”åä¿®æ”¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center text-muted">ğŸ“‚ è¼‰å…¥ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn btn-danger" id="delete-selected">ğŸ—‘ï¸ åˆªé™¤é¸æ“‡</button>
            </div>
        </div>

        
        <!-- è¿”å›é¦–é æŒ‰éˆ• -->
        <div class="text-center mt-4">
            <a href="/" class="btn btn-secondary btn-lg">ğŸ”™ è¿”å›é¦–é </a>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const sshStatus = document.getElementById('ssh-status');

            const socket = new WebSocket("ws://" + window.location.host + "/ws/CMD/");
            
            // ç•¶ WebSocket é€£ç·šæˆåŠŸ
            socket.onopen = function() {
                console.log("WebSocket å·²é€£ç·š");
                sshStatus.innerHTML = `<span class="text-success fw-bold">ğŸŸ¢ ä¼ºæœå™¨ å·²é€£ç·š</span>`;
            };

            const tableBody = document.querySelector("#weights-table tbody");
            const selectAllCheckbox = document.getElementById("select-all");
            const deleteButton = document.getElementById("delete-selected");

            ["filter-name", "filter-date", "mse-min", "mse-max"].forEach(id => {
                document.getElementById(id).addEventListener("input", loadWeights);
            });

            function loadWeights() {
                fetch('/api/list_checkpoint/')
                    .then(res => res.json())
                    .then(data => {
                        console.log("è¼‰å…¥æ¬Šé‡è³‡æ–™:", data); // DEBUG: çœ‹ API å›å‚³

                        const nameFilter = document.getElementById("filter-name").value.toLowerCase();
                        const dateFilter = document.getElementById("filter-date").value;
                        const mseMin = parseFloat(document.getElementById("mse-min").value);
                        const mseMax = parseFloat(document.getElementById("mse-max").value);

                        // éæ¿¾é‚è¼¯
                        const filtered = data.filter(file => {
                            let matchName = !nameFilter || file.name.toLowerCase().includes(nameFilter);
                            let matchDate = !dateFilter || file.date_iso === dateFilter;
                            let matchMSE = true;
                            if (!isNaN(mseMin)) matchMSE = file.mse !== null && file.mse >= mseMin;
                            if (!isNaN(mseMax)) matchMSE = matchMSE && file.mse !== null && file.mse <= mseMax;
                            return matchName && matchDate && matchMSE;
                        });

                        tableBody.innerHTML = "";
                        if (data.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ğŸ“‚ æ²’æœ‰æ¬Šé‡æª”æ¡ˆ</td></tr>';
                            return;
                        }

                        filtered.forEach(file => {
                            const row = document.createElement("tr");
                            row.innerHTML = `
                                <td><input type="checkbox" class="file-checkbox" value="${file.name}"></td>
                                <td>${file.name}.h5</td>
                                <td>${file.size}</td>
                                <td>${file.date}</td>
                                <td>${file.mse !== null ? file.mse : "-"}</td>
                                <td><button class="btn btn-sm btn-outline-primary rename-btn" data-old="${file.name}">âœï¸ ä¿®æ”¹åç¨±</button></td>
                            `;
                            tableBody.appendChild(row);
                        });
                    });
            }

            // å…¨é¸åŠŸèƒ½æŒ‰éˆ•
            const toggleSelectAllButton = document.getElementById("toggle-select-all");
            let isAllSelected = false;

            toggleSelectAllButton.addEventListener("click", function () {
                const checkboxes = document.querySelectorAll(".file-checkbox");
                isAllSelected = !isAllSelected;

                checkboxes.forEach(cb => {
                    cb.checked = isAllSelected;
                });

                // åˆ‡æ›æŒ‰éˆ•æ–‡å­—
                if (isAllSelected) {
                    toggleSelectAllButton.textContent = "å…¨ä¸é¸";
                } else {
                    toggleSelectAllButton.textContent = "å…¨é¸";
                }
            });

            // åˆªé™¤é¸æ“‡æª”æ¡ˆ
            deleteButton.addEventListener("click", function () {
                const selectedFiles = Array.from(document.querySelectorAll(".file-checkbox:checked"))
                    .map(cb => cb.value);
                if (selectedFiles.length === 0) {
                    alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„æª”æ¡ˆï¼");
                    return;
                }
                if (confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™ ${selectedFiles.length} å€‹æª”æ¡ˆå—ï¼Ÿ`)) {
                    fetch('/api/delete_local_weights/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filenames: selectedFiles })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "success") {
                            alert("âœ… åˆªé™¤æˆåŠŸ");
                            loadWeights();
                        } else {
                            alert(`âŒ åˆªé™¤å¤±æ•—ï¼š${data.error}`);
                        }
                    });
                }
            });

            // ä¿®æ”¹åç¨±
            tableBody.addEventListener("click", function (e) {
                if (e.target.classList.contains("rename-btn")) {
                    const oldName = e.target.getAttribute("data-old");
                    const newName = prompt("è«‹è¼¸å…¥æ–°çš„æ¨¡å‹åç¨±ï¼ˆä¸å«å‰¯æª”åï¼‰", oldName);
                    if (newName && newName !== oldName) {
                        fetch('/api/rename_checkpoint/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ old_name: oldName, new_name: newName })
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === "success") {
                                alert("âœ… ä¿®æ”¹æˆåŠŸï¼");
                                loadWeights();
                            } else {
                                alert("âŒ ä¿®æ”¹å¤±æ•—ï¼š" + data.error);
                            }
                        });
                    }
                }
            });

            loadWeights();
        });
    </script>
</body>
</html>